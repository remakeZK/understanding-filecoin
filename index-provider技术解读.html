<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Didact+Gothic&display=swap&subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit inherit; background-repeat: inherit inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit inherit; background-repeat: inherit inherit; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; background-repeat: initial initial; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print { 
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; background-position: initial initial; background-repeat: initial initial; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; background-position: initial initial; background-repeat: initial initial; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); background-position: initial initial; background-repeat: initial initial; }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print { 
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) { 
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) { 
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571429rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ''; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ''; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ''; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: '−'; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; white-space: nowrap; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; border: none !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: 0px 0px; background-repeat: initial initial; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); background-position: initial initial; background-repeat: initial initial; }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


@include-when-export url(https://fonts.loli.net/css?family=Didact+Gothic&display=swap&subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext);

/* cyrillic-ext */
/* cyrillic */
:root {
	--window-border: none;
	--typora-center-window-title: true;
	--active-file-bg-color: #f3f3f3;
	--bg-color: #fcfcfc;
	--control-text-color: #777;
}

.mac-seamless-mode #typora-sidebar {
	top: 20px;
	padding-top: 0;
	height: auto;
}

html,
body,
#write{
	background: #fcfcfc;
	background: var(--bg-color);
	font-family: 'TeXGyreAdventor', "Century Gothic", "Didact Gothic", "Yu Gothic", 'Segoe UI Emoji', sans-serif;
	font-weight: 300;
	-webkit-font-smoothing: antialiased;
}
h1,
h2,
h3,
h4,
h5,
h6 {
	color: #111;
	font-family: 'TeXGyreAdventor', "Century Gothic", "Didact Gothic", "Yu Gothic", sans-serif;
}

html {
	font-size:16px;
}

#write {
	max-width: 914px;
	text-align: justify;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

#write>h1:first-child {
	margin-top: 2.75rem;
}
#write>h2:first-child {
	margin-top: 1.75rem;
}
#write>h3:first-child {
	margin-top: 1rem;
}
#write>h4:first-child {
	margin-top: 0.5rem;
}
h1 {
	font-weight: normal;
	line-height: 4rem;
	margin: 0 0 1.75rem;
	padding: 20px 30px;
	text-align: center;
	text-transform: uppercase;
	margin-top: 4rem;
}
h2 {
	font-weight: normal;
	line-height: 3rem;
	margin: 0 0 1.9375rem;
	padding: 0 30px;
	text-align: center;
	text-transform: uppercase;
	margin-top: 3rem
}
h3 {
	font-weight: normal;
}
h4 {
	font-weight: normal;
}
h5 {
	font-size: 1.125rem;
	font-weight: normal;
}
h6 {
	font-size: 1rem;
	font-weight: bold;
}
p {
	color: #111;
	font-size: 1rem;
	line-height: 1.75rem;
	margin: 0 0 1.25rem;
}
#write>h3.md-focus:before {
	left: -1.875rem;
	top: 0.5rem;
	padding: 2px;
}
#write>h4.md-focus:before {
	left: -1.875rem;
	top: 0.3125rem;
	padding: 2px;
}
#write>h5.md-focus:before {
	left: -1.875rem;
	top: 0.25rem;
	padding: 2px;
}
#write>h6.md-focus:before {
	left: -1.875rem;
	top: .125rem;
	padding: 2px;
}
@media screen and (max-width: 48em) {
	blockquote {
		margin-left: 1rem;
		margin-right: 0;
		padding: 0.5em;
	}
	.h1,
	h1 {
		font-size: 2.827rem;
	}
	.h2,
	h2 {
		font-size: 1.999rem;
	}
	.h3,
	h3 {
		font-size: 1.413rem;
	}
	.h4,
	h4 {
		font-size: 1.250rem;
	}
	.h5,
	h5 {
		font-size: 1.150rem;
	}
	.h6,
	h6 {
		font-size: 1rem;
	}
}
a,
.md-def-url {
	color: #990000;
	text-decoration: none;
}
a:hover {
	text-decoration: underline;
}
table {
	margin-bottom: 20px
}
table th,
table td {
	padding: 8px;
	line-height: 1.25rem;
	vertical-align: top;
	border-top: 1px solid #ddd
}
table th {
	font-weight: bold
}
table thead th {
	vertical-align: bottom
}
table caption+thead tr:first-child th,
table caption+thead tr:first-child td,
table colgroup+thead tr:first-child th,
table colgroup+thead tr:first-child td,
table thead:first-child tr:first-child th,
table thead:first-child tr:first-child td {
	border-top: 0
}
table tbody+tbody {
	border-top: 2px solid #ddd
}
code, .md-fences {
	padding: .5em;
	/*background: #f0f0f0;*/
	border: 1px solid #ccc;
	padding: .1em;
	font-size: 0.9em;
	margin-left: 0.2em;
	margin-right: 0.2em;
}
.md-fences {
	margin: 0 0 20px;
	font-size: 1em;
	padding: 0.3em 1em;
  	padding-top: 0.4em;
}
.task-list{
	padding-left: 0;
}

.task-list-item {
	padding-left:2.125rem;
}

input {
	border-style: ridge;
}

.task-list-item input {
	top: 3px;
}

.md-task-list-item input {
	margin-left: -1.5em;
}

.task-list-item input:before {
	content: "";
	display: inline-block;
	width: 1rem;
	height: 1rem;
	vertical-align: middle;
	text-align: center;
	border: 1px solid gray;
	background-color: #fdfdfd;
	margin-left: 0;
	-webkit-appearance: none;
	margin-top: -1rem;
}

.typora-node .task-list-item input:before {
	top: 0.3ex;
	position: absolute;
}

.task-list-item input:checked:before,
.task-list-item input[checked]:before{
	content: '\25FC';
	/*◘*/
	font-size: 0.8125rem;
	line-height: 0.9375rem;
}

/* Chrome 29+ */
@media screen and (-webkit-min-device-pixel-ratio:0)
  and (min-resolution:.001dpcm) {
    .task-list-item input:before {
    	margin-top: -0.2rem;
    }

    .task-list-item input:checked:before,
	.task-list-item input[checked]:before {
		margin-top: -0.2rem;
	}
}

blockquote {
	margin: 0 0 1.11111rem;
	padding: 0.5rem 1.11111rem 0 1.05556rem;
	border-left: 1px solid gray;
}
blockquote,
blockquote p {
	line-height: 1.6;
	color: #6f6f6f;
}
#write pre.md-meta-block {
	min-height: 30px;
	background: #f8f8f8;
	padding: 1.5em;
	font-weight: 300;
	font-size: 1em;
	padding-bottom: 1.5em;
	padding-top: 3em;
    margin-top: -1.5em;
	color: #999;
	
	width: 100vw;
	max-width: calc(100% + 60px);
	margin-left: -30px;
	border-left: 30px #f8f8f8 solid;
	border-right: 30px #f8f8f8 solid;
}
.MathJax_Display {
	font-size: 0.9em;
	margin-top: 0.5em;
	margin-bottom: 0;
}
p.mathjax-block,
.mathjax-block {
	padding-bottom: 0;
}
.mathjax-block>.code-tooltip {
	bottom: 5px;
	box-shadow: none;
}
.md-image>.md-meta {
	padding-left: 0.5em;
	padding-right: 0.5em;
}
.md-image>img {
	margin-top: 2px;
}
.md-image>.md-meta:first-of-type:before {
	padding-left: 4px;
}

#typora-source {
	color: #555;
}

/** ui for windows **/
#md-searchpanel {
    border-bottom: 1px solid #ccc;
}

#md-searchpanel .btn {
    border: 1px solid #ccc;
}

#md-notification:before {
	top: 14px;
}

#md-notification {
	background: #eee;
}

.megamenu-menu-panel .btn {
	border: 1px solid #ccc;
}

#typora-sidebar {
	box-shadow: none;
}

.file-list-item ,
.show-folder-name .file-list-item {
	padding-top: 20px;
	padding-bottom: 20px;
	line-height: 20px;
}

.file-list-item-summary {
	height: 40px;
	line-height: 20px;
}

.ty-table-edit {
	background: #ededed;
}

.dropdown-menu .divider {
	border-color: #e5e5e5;
}

 @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>index-provider技术解读</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h2 id='index-provider技术解读'><span>Index Provider技术解读</span></h2><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n0"><a class="md-toc-inner" href="#index-provider技术解读">Index Provider技术解读</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4"><a class="md-toc-inner" href="#概述">概述</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n10"><a class="md-toc-inner" href="#关键设计决策">关键设计决策</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n25"><a class="md-toc-inner" href="#数据供应商接口">数据供应商接口</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n33"><a class="md-toc-inner" href="#索引更新公告原文为advertisments">索引更新公告(原文为:Advertisments)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n49"><a class="md-toc-inner" href="#数据供应商对indexer请求的响应">数据供应商对Indexer请求的响应</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n57"><a class="md-toc-inner" href="#响应分页">响应分页</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n59"><a class="md-toc-inner" href="#链式响应">链式响应</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n63"><a class="md-toc-inner" href="#无响应的数据供应商">无响应的数据供应商</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n65"><a class="md-toc-inner" href="#清单-post-mvp---tbd-if-required">清单 (post MVP - TBD if required)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n71"><a class="md-toc-inner" href="#发现数据提供商">发现数据提供商</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n74"><a class="md-toc-inner" href="#公告过滤">公告过滤</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n84"><a class="md-toc-inner" href="#轮询更新">轮询更新</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n86"><a class="md-toc-inner" href="#轮询计划">轮询计划</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n89"><a class="md-toc-inner" href="#供应商验证">供应商验证</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n91"><a class="md-toc-inner" href="#indexer的数据存储">Indexer的数据存储</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n92"><a class="md-toc-inner" href="#response缓存在内存中">Response缓存(在内存中)</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n113"><a class="md-toc-inner" href="#负缓存译者注可以快速返回一个not-exists">负缓存(译者注:可以快速返回一个<code>not exists</code>)</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n115"><a class="md-toc-inner" href="#缓存的指标">缓存的指标</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n129"><a class="md-toc-inner" href="#值存储持久化">值存储(持久化)</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n138"><a class="md-toc-inner" href="#存储指标">存储指标</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n154"><a class="md-toc-inner" href="#客户端接口">客户端接口</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n157"><a class="md-toc-inner" href="#管理相关接口">管理相关接口</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n165"><a class="md-toc-inner" href="#大小规模预估">大小/规模预估</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n169"><a class="md-toc-inner" href="#indexer配置项">Indexer配置项</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n172"><a class="md-toc-inner" href="#indexer扩展策略">Indexer扩展策略</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n178"><a class="md-toc-inner" href="#参考文献">参考文献</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n190"><a class="md-toc-inner" href="#安全性和滥用问题">安全性和滥用问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n206"><a class="md-toc-inner" href="#基准数据">基准数据</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n207"><a class="md-toc-inner" href="#缓存内存用量">缓存内存用量</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n209"><a class="md-toc-inner" href="#持久化存储">持久化存储</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n211"><a class="md-toc-inner" href="#查询耗时">查询耗时</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n228"><a class="md-toc-inner" href="#负载测试">负载测试</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n276"><a class="md-toc-inner" href="#附录-a">附录 A</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n277"><a class="md-toc-inner" href="#通过在indexer集群的节点之间共享index数据实现扩展">通过在indexer集群的节点之间共享index数据实现扩展</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n279"><a class="md-toc-inner" href="#构建indexer集群">构建indexer集群</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n282"><a class="md-toc-inner" href="#处理index更新">处理Index更新</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n285"><a class="md-toc-inner" href="#添加索引节点到集群">添加索引节点到集群</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n287"><a class="md-toc-inner" href="#从集群移除索引节点">从集群移除索引节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n289"><a class="md-toc-inner" href="#索引节点丢失">索引节点丢失</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n291"><a class="md-toc-inner" href="#主从复制">主从复制</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n295"><a class="md-toc-inner" href="#客户请求路由">客户请求路由</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n297"><a class="md-toc-inner" href="#附录-b">附录 B</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n298"><a class="md-toc-inner" href="#通过索引器分层的方式来纵向扩展">通过索引器分层的方式来纵向扩展</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n300"><a class="md-toc-inner" href="#附录-c">附录 C</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n301"><a class="md-toc-inner" href="#处理identity-multihashes">处理<code>IDENTITY</code> multihashes</a></span></p></div><p><span>本文是</span><a href='https://www.notion.so/Indexer-Node-Design-4fb94471b6be4352b6849dc9b9527825#27801c0852c84da2b7a818142ed7abb7'><span>Indexer-Node-Design</span></a><span>的翻译,并加入了一些译者自己的理解.</span></p><h3 id='概述'><span>概述</span></h3><p><strong><span>data provider</span></strong><span> 也就是SP(storage provider, miner), 在本地保存数据的索引. 它们需要发布持有数据的公告,以便潜在客户使用;当数据失效时还能够撤回这些公告.</span>
<strong><span>indexer nodes</span></strong><span> 发现data provider并且追踪其的数据的变化.它们需要处理对数据的请求,解析后, 发送给对应的的data provider. 在无法处理某些请求内容时, 也可能将其转发到其它indexer.</span>
<strong><span>indexer clients</span></strong><span> 向indexer发布类似&#39;findProvider&#39;的请求, 接收包含&#39;provider&#39;集合的响应. 响应中应该包含任何关于如何选择provider的信息, 以及provider被要求提供,以验证请求的信息(例如: deal ID)</span></p><p><span>indexer发现新的data provider后, 通过监听它们发布到gossip pub-sub相关主题上的推送, 接收其关于数据更新的通知. indexer还可以通过监控旷工在链上的活动来发现数据的变化. 这些链上的信息让indexers发现新的数据,并且数据的索引入口能够从某个已经存在或新的provider上获取. indexer可以自由的决定 是否, 何时, 从哪个provider拉取哪些类型的索引, 完全基于indexer对于此provider的策略.</span></p><p><span>为了处理来自任意数量provider的任何规模的索引数据, indexer节点需要能够水平扩展,以便在indexers集群中进行负载均衡. indexer集群的大小需要可以动态变化.</span></p><p><img src="https://github.com/zl03jsj/reading_of_index_provider_on_tecnique/blob/master/indexer_provider_architecture.png?raw=true" referrerpolicy="no-referrer" alt="indexer_provider_architecture"></p><p>&nbsp;</p><h3 id='关键设计决策'><span>关键设计决策</span></h3><ul><li><p><span>indexer 使用</span><a href='https://github.com/multiformats/multihash'><span>Mult-hash</span></a><span>而非</span><code>CIDs</code><span>来指向索引内容</span>
<span>CID的编/解码是独立于被索引的内容,以及从provider检索内容的方式的.</span></p><blockquote><p><sub><span>译者注: multihash是一种自描述的数据格式, 顾名思义, 支持不同算法的hash</span></sub>
<sub><span>0-4字节: hash算法, 4-8字节:hash值的长度, 8-末尾:hash值</span></sub></p><p><span>此外,提取car文件的indics并转换为multihash, 具体细节可以参考: </span><a href='https://github.com/filecoin-project/dagstore/blob/eac7733212fdd7c80be5078659f7450b3956d2a6/dagstore_async.go#L107'><span>DAGStore.initializeShard函数</span></a><span>的具体实现细节.</span></p></blockquote></li><li><p><span>除非配置为仅在内存中操作, indexer会保留客户端请求过的multihas的内存缓存.</span>
<span>由于客户通常只会请求某个对象的顶层multihash,故而索引中的大多数multihash并不会被请求. 因此只有被真正请求过的部分multihash才会被保留在缓存中.剩下的部分会被保存在较为节省空间的二级存储中.一种内存缓存的分代缓存回收机制防止了占用的内存无止境的增长.</span></p></li><li><p><a href='https://github.com/ipld/go-storethehash'><span>StoreTheHash</span></a><span>作为持久化存储服务</span>
<span>旨在高效的存储hash数据,只需2次磁盘读取就能获取任何</span><code>mulithash</code><span>. 由于非常可信的假设为能够节省显著的空间, 其被评价为更加成熟的系统. 然而这种节省需要非常显著才能在意义上超过新存储设施的开发成本和风险.indexer允许不同的实现, 以为不同的部署方案提供合适的选择. 拥有一种嵌入式的实现也许不但能减少管理工作, 而且能更加容易将indexer作为库来使用.</span></p></li><li><p><span>indexer追踪</span><code>multihash</code><span>的分布和使用</span>
<span>index会保持统计</span><code>multihash,</code><span>用于预测数据存储,和缓存的增长率,以及</span><code>multihash</code><span>在provider上的分布情况.也会跟踪</span><code>multihash</code><span>的使用,展示客户对于各种不同</span><code>multihash</code><span>的需求情况.</span></p></li><li><p><span>indexer不会索引</span><code>IDENTITY</code><span> 多重哈希</span>
<span>indexer不会索引</span><code>IDENTITY</code><span>多重hash并从收到的广告中将此类内容过滤掉.</span><sub><span>(参考:</span><a href='https://www.notion.so/Indexer-Node-Design-4fb94471b6be4352b6849dc9b9527825#a37e72d7800e4d59a873e9d0db2b6647'><span>Appendix C, Handling of  IDENTITY Multihashes)</span></a></sub></p></li></ul><h3 id='数据供应商接口'><span>数据供应商接口</span></h3><p><span>data provider在本地保存了其数据的索引,我们可以抽象的把provider暴露出来的资源想象成类似下面的树:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111111640930176px; left: 3.3333740234375px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Catalog</span> (<span class="cm-variable">List</span> <span class="cm-variable">of</span> <span class="cm-variable">Indexes</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Catalog</span><span class="cm-operator">/&lt;</span><span class="cm-variable">id</span><span class="cm-operator">&gt;</span> (<span class="cm-variable">Individual</span> <span class="cm-variable">Index</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Catalog</span><span class="cm-operator">/&lt;</span><span class="cm-variable">id</span><span class="cm-operator">&gt;</span><span class="cm-string-2">/multihashes (list of multihashes in the Index)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Catalog</span><span class="cm-operator">/&lt;</span><span class="cm-variable">id</span><span class="cm-operator">&gt;</span><span class="cm-string-2">/TBD (semantic for selection)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 89px;"></div><div class="CodeMirror-gutters" style="display: none; height: 89px;"></div></div></div></pre><blockquote><p><strong><span>译者注:</span></strong><span> </span>
<span>针对</span><strong><span>Individual Index</span></strong><span>和</span><strong><span>list of multihashes in the Index</span></strong><span>, 有人评论:</span>
<span>问: i don&#39;t understand the difference between these two</span>
<span>答: cids is the hamt of all cids. the full index.</span>
<span>大致可以理解为provider暴露3中类型的资源:</span>
<code>cids[hamt]</code><span>, </span><code>multihashes</code><span>, 以及</span><code>/TBD semantic for selection</code><sub><span>(译者注:这是待确认的项)</span></sub></p></blockquote><p><span>每个provider都有一个用于存放1个或多个index的目录, 其中的当前索引是provider所知的所有</span><code>multihash</code><span>的集合, 其余的index是它的历史版本,每个都代表之前某个时间点的multihashes. 语意上来说,对provider对indexes目录的修改被视为发生在全局有序的添加/撤销日志中,每个都链接之前的操作. indexers通过追踪这些变化记录,来保持它们对provider索引的视图最新.</span></p><blockquote><p><span>译者注: </span>
<span>理解像按时间排序的链表一样, 每个节点上都记录了对index的操作. 如果遍历重放整个链表, 就得到了最新的index集合.</span></p></blockquote><h4 id='索引更新公告原文为advertisments'><span>索引更新公告</span><sub><span>(原文为:Advertisments)</span></sub></h4><blockquote><p><span>译者注:这里的</span><code>Advertisement</code><span>应该理解为公告,provider在libp2b相关topic上发布的其存储数据的索引的相关更新.</span></p></blockquote><p><span>provider在</span><code>content index</code><span>的gossipsub pub-sub的主题中公布其新索引, indexer订阅此主题. 公告消息的格式如下:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111111640930176px; left: 3.3333740234375px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ <span class="cm-variable">Index</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">multihash</span> <span class="cm-variable">of</span> <span class="cm-variable">current</span> <span class="cm-variable">index</span> <span class="cm-variable">manifest</span><span class="cm-operator">&gt;</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Previous</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">multihash</span> <span class="cm-variable">of</span> <span class="cm-variable">previous</span> <span class="cm-variable">index</span> <span class="cm-variable">manifest</span><span class="cm-operator">&gt;</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Provider</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">libp2p</span>.<span class="cm-property">PeerID</span><span class="cm-operator">&gt;</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Signature</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">signature</span> <span class="cm-variable">over</span> <span class="cm-variable">index</span>, <span class="cm-variable">previous</span><span class="cm-operator">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 111px;"></div><div class="CodeMirror-gutters" style="display: none; height: 111px;"></div></div></div></pre><blockquote><p><span>译者注:</span>
<span>大神们在这里对于到底应该放</span><code>multi-addr</code><span>,</span><code>miner-id</code><span>还是</span><code>peer-id</code><span>到清单中发生了激烈的讨论,</span>
<span>因为不管</span><code>multi-addr</code><span>,</span><code>miner-id</code><span>还是</span><code>peer-id,</code>
<span>都最终都可以转换为</span><code>endpoint</code><span>以连接到</span><code>provider</code><span>.最终结果是放</span><code>peer-id</code>
<span>基于几下几点原因:</span></p><ul><li><span>miner的peerid是不变的, 但是</span><code>multiaddr</code><span>是变化的.</span><sub><span>(实际上为peerid也是可以变化的,只是multiaddr可能会随着外部的变化而变化, 比如IP地址变动)</span></sub></li><li><span>如果放</span><code>miner-id</code><span>就只能适用于filecoin上的存储提供者(miner).</span></li></ul></blockquote><p><span>当收到一个公告时,indexer会检查是否已经有了最新的</span><code>index ID</code><span>. 如果已经有了则忽略; 否则向provider发送请求, 获取公告中,从</span><code>Previous</code><span> 到 </span><code>Index</code><span>的变化集合. indexer在内部处理</span><code>peer-id</code><span>到</span><code>endpoint</code><span>的映射.</span>
<span>除了监听pub-sub管道来获取公告的通知之外, indexer也可以直接从provider直接请求最近的公告. 这在发现新的provider时非常有用.</span></p><blockquote><p><span>注:</span><code>Signature</code><span>字段是基于每个条目中&#39;当前&#39;和&#39;Previous&#39; ID计算的. 它保证根据签名的数据提供者, 这个顺序是正确的.</span></p></blockquote><p><span>一个</span><code>Index ID</code><span>总是一个从CID提取的mutihash(因为索引化的内容并没有追踪内容的编码方式), 这应该是来源于由provider托管内容的默克尔树的CID.</span></p><h4 id='数据供应商对indexer请求的响应'><span>数据供应商对Indexer请求的响应</span></h4><p><span>基于</span><code>Provider-Indexer</code><span>的协议,indexer请求如下:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111111640930176px; left: 3.3333740234375px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ <span class="cm-string cm-property">"prev_index_id"</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">get</span> <span class="cm-variable">changes</span> <span class="cm-variable">starting</span> <span class="cm-variable">at</span> <span class="cm-keyword">this</span> <span class="cm-variable">index</span><span class="cm-operator">&gt;</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"index_id"</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">get</span> <span class="cm-variable">changes</span> <span class="cm-variable">up</span> <span class="cm-variable">to</span> <span class="cm-keyword">this</span> <span class="cm-variable">index</span><span class="cm-operator">&gt;</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"start"</span>: <span class="cm-variable">n</span>, <span class="cm-comment">// optional - start at this record (for pagination)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"count"</span>: <span class="cm-variable">n</span>, <span class="cm-comment">// optional - maximum number of records to fetch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 111px;"></div><div class="CodeMirror-gutters" style="display: none; height: 111px;"></div></div></div></pre><p><span>之后, indexer收到可能分页的response, 其中包含了</span><code>changelog</code><span>的子集和相关的公告消息:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111111640930176px; left: 3.3333740234375px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ <span class="cm-string cm-property">"totalEntries"</span>: <span class="cm-variable">n</span>, <span class="cm-comment">// size of provider's catalog</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"error"</span>: <span class="cm-string">""</span>, &nbsp; &nbsp; &nbsp; <span class="cm-comment">// optional. indicate the request could not be served</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string cm-property">"advertisement"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">Index</span>: <span class="cm-variable">n3</span> <span class="cm-operator">&lt;</span><span class="cm-variable">ID</span> <span class="cm-variable">of</span> <span class="cm-variable">index</span> <span class="cm-variable">manifest</span><span class="cm-operator">&gt;</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Previous</span>: <span class="cm-variable">n2</span> <span class="cm-operator">&lt;</span><span class="cm-variable">ID</span> <span class="cm-variable">of</span> <span class="cm-variable">previous</span> <span class="cm-variable">index</span> <span class="cm-variable">manifest</span><span class="cm-operator">&gt;</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Provider</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">libp2p</span>.<span class="cm-variable">AddrInfo</span><span class="cm-operator">&gt;</span>, <span class="cm-variable">Signature</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">signature</span>(<span class="cm-variable">index</span>, <span class="cm-variable">previous</span>)<span class="cm-operator">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"start"</span>: <span class="cm-variable">n</span>, &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">// starting entry number</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"entries"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {<span class="cm-string cm-property">"add_multihashes"</span>: [<span class="cm-operator">&lt;</span><span class="cm-variable">multihash</span><span class="cm-operator">&gt;</span>, <span class="cm-meta">...</span>], <span class="cm-string cm-property">"metadata"</span>: <span class="cm-string">"???"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string cm-property">"del_multihashes"</span>: [<span class="cm-operator">&lt;</span><span class="cm-variable">multihash</span><span class="cm-operator">&gt;</span>, <span class="cm-meta">...</span>]}, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {<span class="cm-string cm-property">"add_multihashes"</span>: [<span class="cm-operator">&lt;</span><span class="cm-variable">multihash</span><span class="cm-operator">&gt;</span>, <span class="cm-meta">...</span>], <span class="cm-string cm-property">"metadata"</span>: <span class="cm-string">"???"</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 289px;"></div><div class="CodeMirror-gutters" style="display: none; height: 289px;"></div></div></div></pre><p><span>这是从请求中</span><code>prev_multihash</code><span>开始的, 应用到index数据的修改的集合. 每个</span><sub><span>译者注:response中</span><code>entries</code><span>字段中的</span></sub><span>entry包含, 一组provider新增的multihash;1组(可能有)被移除的不在有效的multihash;被限制(&lt;=100字节)的</span><code>metadata</code><span>字段,包含特定于提供者与添加的multihash相关的数据.</span><sub><span>译者注:</span><code>metadata</code><span>到底是什么没说清楚.应该举个例子.</span></sub><span> </span><code>metadata</code><span>以protocal ID 作为前缀,后跟根据协议编码的数据.metadata的内容有provider提供,如果需要的大小超过的限制,元数据中应该包含provider存储的ID,标识模式复杂数据.</span></p><p><span>值得注意的是,同一个multihash可能重复出现在同一个provider的多个不同的公告条目中.例如, 假设某个filecoin中的miner收到一个某部分数据曾经被索引过的新的deal, 其中包含一个CID, CID中包含一个multihash. 那么,可能会在下一次的公告中为这个multihash包含一个带有新</span><code>metadata</code><sub><span>(例如:deal的新过期时间)</span></sub><span>的条目,以便将此更新通知到indexer节点.</span></p><p><span>当indexer发现provider中的某个multihash已经存在,则只更新</span><code>metadata</code><span>就就可以了.最终,如果包含此multihash的所有deal都过期了,provider将此multhash添加到下一次公告的`del_multihashes中, 以便通知indexer节点.</span></p><h5 id='响应分页'><span>响应分页</span></h5><p><span>请求的响应可能由于请求指定了最大条目数量或者传输的条目数量达到了配置的最大值而分页.为了获取其余的条目,需要在后续的请求中设置start值为之前获取过的所有条目的数量. 所:如果</span><code>totalEntries</code><span>是</span><code>100</code><span>, 且response中包含了50条, 接下来的请求就应该将</span><code>start</code><span>这是为</span><code>50</code><span>, 直到indexer获取完整的条目.</span></p><h5 id='链式响应'><span>链式响应</span></h5><p><span>indexer保留了公告过的索引的多重哈希的记录, indexer一直往后回退, 直到某个response中包含的</span><code>Previous</code><span>multihash等于indexer的最新值, 或者到达链的头部(没有previous了)为止.当所有的链上所有缺失的索引都被按顺序的被应用.以更新indexer的multihash记录和数据提供者.</span></p><blockquote><p><span>译者注: 这里描述的方法是不是和filecoin链的同步逻辑极其相似?</span></p></blockquote><h4 id='无响应的数据供应商'><span>无响应的数据供应商</span></h4><p><span>indexer可以配置为在它们没有通过gossip pub-sub收到任何内容持续一定时间的情况下,定期轮询provider来更新公告.此外可以将indexer配置为,在provider既不响应轮询请求,也不主动发送任何更新通知一定次数的情况下, 直接清除provider的数据.</span></p><h4 id='清单-post-mvp---tbd-if-required'><span>清单 (post MVP - TBD if required)</span></h4><p><span>随着provider的index变化,每次修改都导致新增一组multihash到index中. 索引multihash与其对应的multihash集合被记录在通过IPFS提供的的Manifest记录中.这意味着provider公告的每次更改都有对应的manifest.</span></p><p><span>每个provider同样应该支持最新Manifest有效的IPNS</span><sub><span>(译者注:IPNS: Inter-Planetary Naming Service, 用于将url映射为IPFS系统中的一串hash, PieceMount.Deserialize有关?)</span></sub><span> 地址一个独立index条目的manifest应该是下面的结构:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111111640930176px; left: 3.9930419921875px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string cm-property">"Version"</span>: <span class="cm-string">"1"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string cm-property">"Full"</span>: <span class="cm-string">"&lt;multihash of full index&gt;"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string cm-property">"Selected"</span>: <span class="cm-string">"&lt;multihash of selective index&gt;"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string cm-property">"Timestamp"</span>: <span class="cm-string">"&lt;time stamp index was provided&gt;"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string cm-property">"Supplants"</span>: <span class="cm-string">"&lt;multihash of previous manifest this entry replaces&gt;"</span>, <span class="cm-comment">// optional</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 156px;"></div><div class="CodeMirror-gutters" style="display: none; height: 156px;"></div></div></div></pre><p><span>如果indexer中没有某个provider的前一个记录,indexer可以用manifest(假设piece CIDs在这里可用)来为此provider初始化其multihash. indexer可以用这种方法来更新其某个provider的记录,但是处理manifest引用的multihash全集比只请求获取provider的修改日志工作量大得多.indexer需要计算每两个前后清单之间的变化来确认哪些部分需要更新. 或者, indexer需要移除provider的所有记录,然后重新保存manifest中的所有multihash.</span></p><p><span>如果provider为了最新manifest提供了</span><code>IPNS</code><span>记录, indexer就能够定期检查最新的manifest是否变化. 如果变化, 则触发indexer向provider请求更新.这是接收公告或者直接寻轮provider的一种可能的替代方案.indexer能在多大程度上利用这一点尚待确认.</span></p><h4 id='发现数据提供商'><span>发现数据提供商</span></h4><p><span>当pub-sub通道上出现了新的provider的公告时, 新的provider就被发现了. priovider也能由独立的代理发现.indexer并不清楚agent是如何发现provider的. 只有当代理将新发现的provider的</span><code>libp2b-peerID</code><span>发送到indexer的</span><code>discovery</code><span>接口上时,indexer才知道.</span></p><p><span>这样设计好处是,允许任何类型的代理被独立于indexer构建出来, 并且能够将新发现的provider通知给任意的indexer.代理也许拥有区块扫描的能力,或者它仅仅是简单的读取一个地址文件, 然后将其报告给indexer.</span></p><h5 id='公告过滤'><span>公告过滤</span></h5><p><span>可以使用黑/白名单过滤公告. 这些名单定义在indexer的配置中.名单中包含provider的ID.</span></p><ul><li><span>如果使用白名单,则provider没有在白名单中的公告会被忽略.</span></li><li><span>如果使用黑名单,则来自任何名单上的provider的公告都会被阻止.</span></li><li><span>如果黑白名单都被配置,则优先使用白名单,忽略黑名单.</span></li></ul><p><span>初始indexer部署时,使用了白名单,选则较小的provider的集合来开始.</span></p><h5 id='轮询更新'><span>轮询更新</span></h5><p><span>Indexer节点可能会轮询已知的provider更新index.这在indexer或者provider离线或错过了某些公告, 或者provider选择不发布更新公告的情况下是有非常有用.indexer向provider发送最新公告的请求.provider回复最新的公告. indexer处理这个公告的方式与其处理通过gossip pub-sub收到的公告完全一样.</span></p><h5 id='轮询计划'><span>轮询计划</span></h5><p><span>轮询计划是在indexer配置文件中的</span><code>UpdateSchedule</code><span>节中指定的,这里有一个默认的</span><code>&quot;Poll&quot;</code><span>项指定了</span><code>定时任务</code><span>的值.如果没有设置, 则默认不会有轮询任务.对于不同的provider也有同样的配置项,用于覆盖默认全局配置.</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.111111640930176px; left: 3.3333740234375px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"UpdateSchedule"</span>: {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"Poll"</span>: <span class="cm-string">"0 0 * * *"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">&lt;</span><span class="cm-variable">provider</span><span class="cm-operator">-</span><span class="cm-variable">id</span><span class="cm-operator">&gt;</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string">"Poll"</span>: <span class="cm-string">"0 /12 * * *"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 111px;"></div><div class="CodeMirror-gutters" style="display: none; height: 111px;"></div></div></div></pre><h5 id='供应商验证'><span>供应商验证</span></h5><p><span>索引的增加和删除应该与其它需要验证身份的资源一样,一视同仁.provier不允许伪造或篡改其它provider的索引.</span>
<span>每个索引更新的公告都应该包含provider的签名. 如果indexer无法验证签名, 则公告被丢弃.indexer用provider在公告中提供的provider ID来查找签名证书.</span>
<span>旷工的公钥应该在链上并且能够通过lotus节点来查找.其它类型的provider也许需要不同的方式来获取它们的公钥(证书).</span></p><h3 id='indexer的数据存储'><span>Indexer的数据存储</span></h3><h4 id='response缓存在内存中'><span>Response缓存(在内存中)</span></h4><p><span>压缩字典树(又名:基数树), 或其它能够提供时间/空间性能的数据结构, 将被用来在内存中缓存请求的响应. 要求O(n)的搜索时间复杂度,且比hash映射的存储更加高效.检索时间必须在10ms以内. 存储的数据是multihash到proivder及其指定的metadata的列表的映射.</span></p><p><strong><span>数据存储</span></strong></p><ul><li><span>Key: multihash(二进制)</span></li><li><span>Value: [{provider_id:&lt;libp2p_peer_id&gt;, metadata:&quot;bytes&quot;}, ..]</span></li></ul><p><span>提供multihash来进行查找,mutilhash解码后的原始hash字节被用于在缓存中进行查找.</span>
<span>存储的值是</span><code>provider_id</code><span>-</span><code>piece_multihash</code><span>对的列表.实际的存储并不是json格式, 只是在输出到客户端时编码为json.不同的multhash 键映射到相同的值时,不应该存储重复的拷贝, 而应该使用引用.</span></p><p><strong><span>缓存淘汰策略</span></strong></p><p><span>当缓存到达配置容量的50%时, 就会创建一个新的缓存实例与之前的并存.当收到客户端请求, 优先从新的缓存查找,然后才查找旧的.当缓存大小到达配置的限制,老的缓存就会被移除,再次重新创建一个新的空缓存出来,循环往复.这种策略是为了避免在缓存中保存时间戳或者LRU计数器</span><sub><span>译者注:为了更节省空间?</span></sub>
<span>当一个indexer被引导并获取其初始数据时,其缓存可以使用这种策略填充和管理,以便一开始就加载部分或者所有的multihash. 随着时间推移,只有客户需要的数据才会被保留.</span></p><blockquote><p><span>译者注:这里讲了一些缓存上的细节, 但引出了许多疑问:</span></p><ol start='' ><li><span>文中说查找数据时, 先从新的缓存上查询然后再查老的缓存, 很明显当新缓存才创建的一段时间, 并没有什么数据,此时优先从其中开始查询很明显命中率是非常低的.为什么不优先从老的开始查询呢?</span></li><li><span>如果优先从新的开始查询, 并没有命中, 然后再从老的查询, 那么会把数据写入到新的缓存中吗?</span></li><li><span>文中说当缓存大小达到限制时, 会移除老的缓存, 带来的问题是: 突然移除一半缓存, 是否会导致缓存的命中突然出现猛烈的下降?</span></li></ol><p><span>这是留下来的疑问, 也是需要我们思考和弄清楚的地方.</span></p></blockquote><h5 id='负缓存译者注可以快速返回一个not-exists'><span>负缓存</span><sub><span>(译者注:可以快速返回一个</span><code>not exists</code><span>)</span></sub></h5><p><span>查找没有命中缓存时就会去二级存储中查找,这会花费更多的时间和更大的资源消耗.negative cache用于快速响应Indexer上不存在的multihash的请求. 如果此缓存具有不同的大小或者其中的item具有不同的生命周期,它可以独立于主缓存.</span></p><h5 id='缓存的指标'><span>缓存的指标</span></h5><ul><li><span>缓存命中,丢失</span></li><li><span>负缓存命中和丢失</span></li><li><span>multihash条目数量,内存用量</span></li><li><span>命中耗时,丢失耗时</span></li><li><span>Rotations</span><sub><span>译者注:不太理解这个指标..</span></sub></li><li><span>Provider请求计数</span></li></ul><h4 id='值存储持久化'><span>值存储(持久化)</span></h4><p><span>已有解决方案:</span></p><ul><li><span>Postgres, CassandraDB, FoundationDB, etc.</span></li><li><span>Pogreb(imbedded), RocksDB(high scale, battle-tested and Facebool)</span></li></ul><p><span>Indexer和miner之间的规模差异妨碍它们使用同样的解决方案.</span></p><p><span>data client不会请求大量的index数据,因此不需要将这些数据保存在主内存中.这些数据应该以空间消耗最小化的方式来存储,但当人工检索时,任然需要做出亚秒级别延迟的响应.数据库</span><a href='https://github.com/ipld/go-storethehash'><code>storethehash</code></a><span>是为高效存储hash数据而专门设计的,如果要支持删除和更新,需要对其进行一些修改.</span>
<span>二级存储中的数据与主缓存中的数据一样.</span><sub><span>译者注:这里的&#39;数据一样&#39;,是说的种类, 而不是说的内容</span></sub><span>,但取决于不同的存储情况,可能有不同的形式(待定中).二级存储的配置是可选的,如果不配置,indexer只会操作内存数据,替代在二级存储中写入更新, 且不会循环它的缓存</span><sub><span>(译者注: 这里的&#39;循环&#39;&#39;是前面讲的缓存淘汰机制)</span></sub><span>.</span></p><h5 id='存储指标'><span>存储指标</span></h5><ul><li><span>Multihashes found, multihashes not found</span></li><li><span>Number of multihash entries, storage used</span></li><li><span>Found latency, not found latency</span></li><li><span>Adds, deletes.</span></li><li><span>Compaction time, storage reclaimed</span></li><li><span>Multihash count by provider</span></li><li><span>Multihash count + and - delta per day, week, month</span></li></ul><h3 id='客户端接口'><span>客户端接口</span></h3><blockquote><p><span>译者注:client就是向indexer发送multihash, 查询multihash对应的proivder的</span><code>libp2p_peer_id</code><span>和</span><code>metadata</code><span>, 所以略过,</span>
<span>感兴趣的可以去阅读原文.</span></p></blockquote><h3 id='管理相关接口'><span>管理相关接口</span></h3><p><span>管理相关的接口包含两大类:</span></p><ul><li><span>健康检查 - 输出正常运行时间和错误</span></li><li><span>指标 - 输出当前的指标</span><sub><span>译者注:之前的缓存和存储两个章节提及一些指标</span></sub></li></ul><p><span>健康检查接口主要用于自动检查indexer是否运行, 以及是否出现一些错误情况.</span>
<span>指标接口主要用于报告indexer节点当前的运行水平.</span></p><h3 id='大小规模预估'><span>大小/规模预估</span></h3><p><span>持有验证订单的旷工: 135</span>
<a href='https://filplus.d.interplanetary.one/miners' target='_blank' class='url'>https://filplus.d.interplanetary.one/miners</a>
<span>存储客户在交易中使用改的数据量:~215 TiB (为客户分配的总量为~780TiB,但大部分并没有使用.</span><sub><span>译者注:cc sector?细节不清楚</span></sub><span>)</span></p><p><span>Dumbo drop(7月): 订单总容量约1600个驱动器(每个驱动器约7000个deal.) </span><sub><span>译者注:这里的驱动器是说的sector吗?</span></sub></p><p><span>网络应该允许数据供应商声明数十亿级别的内容地址.</span></p><h3 id='indexer配置项'><span>Indexer配置项</span></h3><blockquote><p><span>译者注:略</span></p></blockquote><h3 id='indexer扩展策略'><span>Indexer扩展策略</span></h3><ul><li><span>indexer集群:</span><a href='#附录-a'><span>附录 A</span></a></li><li><span>Indexer分层: </span><a href='#附录-b'><span>附录 B</span></a></li></ul><h3 id='参考文献'><span>参考文献</span></h3><ol start='' ><li><a href='https://www.notion.so/Indexer-Ingestion-Interface-4a120c698b31417385204ec401137cb1'><span>Miner(or dataset producer)&lt;&gt;Indexer Design</span></a></li><li><a href='https://www.notion.so/e12c58ebc07c40a2a8e5fb488493de00'><span>IPFS Collections spec</span></a></li><li><a href='https://docs.google.com/document/d/18Ryov6vxZOwhG5xjt7EcKpEwAtsrGJZ3jiyj4Bhlag0/edit'><span>Composable Routing spec design</span></a></li><li><a href='https://docs.google.com/document/d/1bGQ3-1u1XgfcXrb0FqbPLtelaOFpuRpsKTpyrgTtfDs/edit'><span>Composable Routing spec language v0</span></a></li><li><a href='https://www.notion.so/d9a60743ae3e459ca6f7c9e22508d862'><span>nitro wishlist for &quot;large provider dht&quot;</span></a></li></ol><h3 id='安全性和滥用问题'><span>安全性和滥用问题</span></h3><ul><li><span>当被评定为</span><code>Bad</code><span>的miner被加入黑名单后,修改其&#39;PeerId&#39;继续重新连接.</span></li><li><span>不应该允许miner伪装成其它旷工来破坏别人的评级.</span></li><li><span>旷工对indexer发起泛洪攻击,不停的修改</span><code>PeerId</code><span>假装为不同的旷工.</span></li><li><span>大量随机multihash对indexer发起Dos攻击, 导致由于</span><code>负缓存</code><span>无法命被中, 增加二级存储访问.</span></li><li><span>防止DDOS攻击的旷工利用indexer的协议 - 我们需要确保将旷工运行的软件用于服务市场过程中的索引请求(not the critial miner process), 注意不要接收来自单个indexer的大量的庞大的数据内容的请求.</span></li><li><span>旷工运行它们自己的indexer偏向自己.</span></li><li><span>对hash数据加盐以掩盖</span><sub><span>译者注:不是很理解这个问题的危害?</span></sub></li></ul><h3 id='基准数据'><span>基准数据</span></h3><h4 id='缓存内存用量'><span>缓存内存用量</span></h4><p><img src="https://github.com/zl03jsj/reading_of_index_provider_on_tecnique/blob/master/cache_mem_use.png?raw=true" referrerpolicy="no-referrer" alt="cache mem use">
<span>存储100万条mutlhash大概使用200M内存.</span></p><h4 id='持久化存储'><span>持久化存储</span></h4><p><img src="https://github.com/zl03jsj/reading_of_index_provider_on_tecnique/blob/master/cids_storage_use.png?raw=true" referrerpolicy="no-referrer" alt="storage use per CIDs in storage">
<span>图中展示的是</span><a href='https://github.com/ipld/go-storethehash'><code>StoreTheHash</code></a><span>和</span><code>Pogreb</code><span>数据库的数量/用量图.</span></p><h4 id='查询耗时'><span>查询耗时</span></h4><figure><table><thead><tr><th><u><span>Aa</span></u></th><th><span>Storethehash数据库</span></th><th><span>Pogreb数据库</span></th><th><span>对比差异</span></th></tr></thead><tbody><tr><td><span>平均耗时 获取单个(ms)</span></td><td><span>0.003</span></td><td><span>0.012</span></td><td><span>75%</span></td></tr><tr><td><span>平均耗时 并发-20个协程(ms)</span></td><td><span>0.008</span></td><td><span>0.047</span></td><td><span>82.98%</span></td></tr></tbody></table></figure><h4 id='负载测试'><span>负载测试</span></h4><p><span>测试环境为:AWS的t2.xlarge, st1存储使用</span><code>storetheindex</code><span>.实例对外暴露API监听请求.从我本机环境发送GET请求到API来产生负载. 请求中的multihash是从数据集中随机抽取, 遵守:(i) Zipf分布; (ii) uniform分布.</span></p><blockquote><p><span>译者注: </span>
<span>Zipf分布:20%的资源占了总请求量的80%. 及我们常说的2/8原则.</span>
<span>uniform分布:随机分布, 均匀分布</span></p><p><span>下面的图标中, 分别展示了请求基于这两种分布的时候, 不同的性能表现.</span></p></blockquote><figure><table><thead><tr><th>&nbsp;</th><th><u><span>Aa</span></u><span>sth</span></th><th><span>sth+cache</span></th><th><span>cache</span></th></tr></thead><tbody><tr><td><span>Zipf分布</span></td><td><span>中位数: 160ms</span></td><td><span>中位数: 160ms</span></td><td><span>中位数: 140ms</span></td></tr><tr><td>&nbsp;</td><td><span>95%耗时: 210ms</span></td><td><span>95%耗时: 200ms</span></td><td><span>95%耗时: 170ms</span></td></tr><tr><td>&nbsp;</td><td><span>~5100 rps </span><sub><span>requests per seconds</span></sub></td><td><span>~5100 rps</span></td><td><span>~5100 rps</span></td></tr><tr><td><span>随机multihahs</span></td><td><span>中位数: 170ms</span></td><td><span>中位数:170ms</span></td><td><span>中位数:170ms</span></td></tr><tr><td>&nbsp;</td><td><span>95%耗时: 370ms</span></td><td><span>95%耗时:330ms</span></td><td><span>95%耗时:300ms</span></td></tr><tr><td>&nbsp;</td><td><span>~4200 rps</span></td><td><span>~4200 rps</span></td><td><span>~4200 rps</span></td></tr></tbody></table></figure><ul><li><span>当增加大量并发用户时, 系统达到的限制是最大打开文件数. 我们确定已经将ulimits设置为最大值.系统支持为:当1000-1100左右的并发用户时u, 不会出现open file超过限制的问题; 并发超过1100的并发后, API就会由于打开的文件数太多产生一些等待, 但不会有请求被丢失,请求会被处理, 不会发生错误; 但对于zipf分布和uniformly分布, 我们似乎能达到的最大吞吐量分别为5100 rps(req/s) 和 4200 rps.</span></li><li><span>在检测中, 没有达到磁盘io的最大限制.</span></li><li><span>在为cache和storethehash运行基准测试时, 我们看到了get操作巨大的数量级差异.但在这些差异在网络中运行时却并不明显(这是有道理的).可以看出使用zipf分布来测试cache时,缓存大小对测试结果的影响很明显.为了充分利用缓存,我们也许需要额外的基准来确定最佳大小.</span></li></ul><h3 id='附录-a'><span>附录 A</span></h3><h4 id='通过在indexer集群的节点之间共享index数据实现扩展'><span>通过在indexer集群的节点之间共享index数据实现扩展</span></h4><p><span>本节将尝试定义一个最小化indexer集群的实现.目的是调查是否用这样一个简单的解决方案就可行且足够了, 或者它是否需要解决很多现有方案中已经解决的问题.</span>
<span>如果indexers需要支持的不仅仅是简单的分工,那么可以在现有分布式方案上构建接口来提供功能.有许多分布式数据方案, 例如: </span><a href='https://cassandra.apache.org/cassandra-basics/'><span>Cassanrda</span></a><span>, </span><a href='https://www.cockroachlabs.com/'><span>CockroachDB</span></a><span>, </span><a href='https://www.yugabyte.com/'><span>yugabytedb</span></a><span>, 等. 也有像ke </span><a href='https://zookeeper.apache.org/'><span>Zookeeper</span></a><span>, </span><a href='https://etcd.io/'><span>etcd</span></a><span> 这样的分布式共识的系统, 如果它们解决了indexer的必要问题,则应该考虑它们.</span></p><h5 id='构建indexer集群'><span>构建indexer集群</span></h5><p><span>可以构建一个协作indexer集群,每个indexer值负责处理multihash键空间的不同区间.indexer配置指定集群中的所有成员并且所有的成员必须共享相同的配置.划分的区间由手工配置.</span></p><p><span>由于所有的成员都订阅了公告的pub-sub通道,消息公告会被所有的成员收到.当indexer收到消息时,检查当前索引multihash确定是否由它来负责处理.</span></p><h5 id='处理index更新'><span>处理Index更新</span></h5><blockquote><p><span>译者注:又把前面的链式更新讲了一遍,所以略.</span></p></blockquote><h5 id='添加索引节点到集群'><span>添加索引节点到集群</span></h5><p><span>支持动态添加节点到集群.修改每个indexer的配置重新指定了其需要处理的multihash的区间.当新的indexer上线,在每个indexer上执行一条重新平衡的命令, 集群中的indexer就自动重新平衡它们负责的区间. 这个操作将会让index重新加载其配置文件, 并将其不再负责的multihash发送给其它对应的indexer.当所有multihash被重新分配完成, 就可以将它们从存储中移除.在重新平衡过程中, 正好遇到一个查询其负责范围内的multihash请求, 如果索引器没有数据, 则请求将转发到之前处理multihash的indexer上(如果它还在线).</span></p><h5 id='从集群移除索引节点'><span>从集群移除索引节点</span></h5><p><span>支持动态移除集群中的节点,方法与动态添加一样.只是被删除的节点, 必须最后命令平衡命令.</span></p><h5 id='索引节点丢失'><span>索引节点丢失</span></h5><p><span>当索引节点丢失,其负责的multihash就不在可用了,请求会收到一个503(服务不可达)的错误. 除非此时有另外的indexer集群来支持multihash(请看:&quot;主从复制&quot;章节).如果没有备用的indexer集群,这些丢失的multihash会在每个provider中重新构建.</span></p><h5 id='主从复制'><span>主从复制</span></h5><p><span>通过配置第二个集群可以启动indexer集群的备用集群.当集群中的indexer丢失后,此indexer负责的multihash会直接路由到其它的集群上, 直到丢失的indexer重新上线并完成加载必要的multihash.节点重新上线会,通过自动从备用池中的索引节点同步来追上丢失的index.</span>
<span>备用集群与主集群之间的唯一区别是他们不与provider通信,而是依赖主集群来发送更新.备用集群可用于负载均衡.</span></p><blockquote><p><span>译者注:</span>
<span>前面说当节点丢失,会将丢失节点负责的multihash请求路由给备用节点.</span>
<span>但又说备用集群依赖主集群来更新索引.</span>
<strong><span>疑惑的地方就是:</span></strong>
<span>如果主节点丢失了, 而从节点又依赖主集群来更新, 那从节点岂不是没办法更新? 此时把multihash的请求路由到备节点岂不是白费心机?</span>
<span>所以,这里面应该还有一些细节没有说清楚..</span></p></blockquote><h5 id='客户请求路由'><span>客户请求路由</span></h5><p><span>客户必须从正确的索引节点请求响应.如果client对此并不清楚,可以先向任意一个indexer发送一个请求. indexer会在返回值中包含的所有multihash; 对于其不包含的, 则会返回对应的indexer地址.</span></p><h3 id='附录-b'><span>附录 B</span></h3><h4 id='通过索引器分层的方式来纵向扩展'><span>通过索引器分层的方式来纵向扩展</span></h4><p><span>索引节点可以分层, 顶层root索引节点知道一组其它的节点,并将请求委托过去.委托的节点可以把被委托的节点的响应缓存起来. 这样,没有一个单独的节点需要保存所有的数据供应商的索引.如果一个索引节点保存数据的量很大, 我们应该将其拆分成多个.</span>
<span>数据供应商可能有它们自己的索引节点,并或许填充多个索引节点来实现冗余.高等级的委托节点需要过滤从多个委托节点返回的响应,并在将唯一值缓存起来.</span>
<span>待定: 索引节点是否应该能够存储值,并委托给其它节点?</span></p><h3 id='附录-c'><span>附录 C</span></h3><h4 id='处理identity-multihashes'><span>处理</span><code>IDENTITY</code><span> multihashes</span></h4><p><span>Indexer node does not index </span><code>IDENTITY</code><span> multihashes. It is the responsibility of the provider to make sure any links within such multihashes are explicitly indexed instead. For example, if an </span><code>IDENTITY</code><span> multihash is root of a DAG that within its data block has Links to other non-identity CIDs, then the provider needs to publish advertisements that include the non-identity CIDs. Simply publishing the root </span><code>IDENTITY</code><span> CID is not sufficient and will result in the DAG being unindexed.</span></p><p><span>The rationale for this design decision is to discourage the indexing of root identities alone and instead encourage providers to index all their available content and their corresponding multihashes. This will facilitate partial DAG retrieval and open opportunities for caching when DAGs have overlapping content.</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div></div>
</body>
</html>